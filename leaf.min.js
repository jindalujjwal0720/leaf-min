(()=>{var z={set:3,to:4,always:5,change:6,and:7,or:8,task:9,if:10,then:16,else:11,for:12,from:13,in:14,by:15},J={plus:17,minus:17,times:17,divide:17,modulo:17};function m(r="",e){return{value:r,type:e}}function k(r){return r.toUpperCase()!=r.toLowerCase()}function W(r){return r==" "||r=="	"||r=="\r"||r==`
`}function I(r){let e=r.charCodeAt(0),t=["0".charCodeAt(0),"9".charCodeAt(0)];return e>=t[0]&&e<=t[1]}function Y(r){for(;r.length>0&&r[0]!="\r"&&r[0]!=`
`;)r.shift();r.shift()}function S(r){let e=new Array,t=r.split("");for(;t.length>0;)if(t[0]==".")if(t.shift(),t[0]==".")e.push(m("..",21)),t.shift();else throw"Invalid token: .";else if(t[0]==",")e.push(m(t.shift(),20));else if(t[0]=="(")e.push(m(t.shift(),22));else if(t[0]==")")e.push(m(t.shift(),23));else if(t[0]=="[")e.push(m(t.shift(),24));else if(t[0]=="]")e.push(m(t.shift(),25));else if(t[0]=="{")e.push(m(t.shift(),26));else if(t[0]=="}")e.push(m(t.shift(),27));else if(t[0]=="="||t[0]=="<"||t[0]==">"||t[0]=="!"){let a=t.shift();t.length>1&&t[0]=="="?e.push(m(a+t.shift(),18)):a=="="?e.push(m(a,19)):a!="!"?e.push(m(a,18)):(console.error("Invalid token: ",a),Deno.exit(1))}else if(t[0]=="+"||t[0]=="-"||t[0]=="*"||t[0]=="/"||t[0]=="%")e.push(m(t.shift(),17));else if(t[0]=="#")Y(t);else if(t[0]=='"'){t.shift();let a="";for(;t.length>0&&t[0]!='"';)a+=t.shift();t.shift()!='"'&&(console.error("Invalid string literal: ",a,' - Missing closing "'),Deno.exit(1)),e.push(m(a,2))}else if(I(t[0])){let a="",n=0;for(;t.length>0&&(I(t[0])||t[0]==".");)if(a+=t.shift(),t[0]=="."){if(t.length>1&&t[1]==".")break;n++}n>1&&(console.error("Invalid number literal: ",a),Deno.exit(1)),e.push(m(a,0))}else if(k(t[0])){let a="";for(;t.length>0&&k(t[0]);)a+=t.shift();let n=J[a],i=z[a];n?e.push(m(a,n)):i?e.push(m(a,i)):e.push(m(a,1))}else W(t[0])?t.shift():(console.error("Unreconized character found in source: ",t[0].charCodeAt(0),t[0]),Deno.exit(1));return e.push(m("EndOfFile",28)),e}var _=class{tokens=[];not_eof(){return this.tokens[0].type!=28}at(){return this.tokens[0]}eat(){return this.tokens.shift()}expect(e,t){let a=this.tokens.shift();return(!a||a.type!=e)&&(console.error(`Parser Error:
`,t,a," - Expecting: ",e),Deno.exit(1)),a}produceAST(e){this.tokens=S(e);let t={kind:"Program",body:[]};for(;this.not_eof();)t.body.push(this.parse_stmt());return t}parse_stmt(){switch(this.at().type){case 3:return this.parse_var_declaration();case 6:return this.parse_assignment_expr();case 9:return this.parse_task_declaration();case 10:return this.parse_if_stmt();case 12:return this.parse_for_stmt();case 13:return this.parse_from_stmt();default:return this.parse_expr()}}parse_for_stmt(){this.eat();let e=this.expect(1,"Unexpected token found while parsing for loop. Expected identifier.");if(this.at().type==13){this.expect(13,"Unexpected token found while parsing for loop. Expected 'from' keyword.");let t=this.parse_additive_expr();this.expect(4,"Unexpected token found while parsing for loop. Expected 'to' keyword.");let a=this.parse_additive_expr(),n={kind:"NumericLiteral",value:1};this.at().type==15&&(this.eat(),n=this.parse_additive_expr());let i;return this.at().type==26?i=this.parse_block():i=[this.parse_stmt()],{kind:"ForFromStmt",identifier:{kind:"Identifier",symbol:e.value},from:t,to:a,body:i,by:n}}else if(this.at().type==14){this.expect(14,"Unexpected token found while parsing for loop. Expected 'in' keyword.");let t=this.parse_range_expr(),a;return this.at().type==26?a=this.parse_block():a=[this.parse_stmt()],{kind:"ForInStmt",identifier:{kind:"Identifier",symbol:e.value},iterable:t,body:a}}throw new Error("Unexpected token found while parsing for loop. Expected 'from' or 'in' keyword.")}parse_from_stmt(){this.eat();let e=this.parse_additive_expr();this.expect(4,"Unexpected token found while parsing from loop. Expected 'to' keyword.");let t=this.parse_additive_expr(),a={kind:"NumericLiteral",value:1};this.at().type==15&&(this.eat(),a=this.parse_additive_expr());let n;return this.at().type==26?n=this.parse_block():n=[this.parse_stmt()],{kind:"FromStmt",from:e,to:t,body:n,by:a}}parse_if_stmt(){this.eat();let e=this.parse_expr();this.at().type==16&&this.eat();let t;return this.at().type==26?t=this.parse_block():t=[this.parse_stmt()],this.at().type==11?(this.eat(),this.at().type==10?{kind:"IfStmt",condition:e,thenBranch:t,elseBranch:[this.parse_if_stmt()]}:this.at().type==26?{kind:"IfStmt",condition:e,thenBranch:t,elseBranch:this.parse_block()}:{kind:"IfStmt",condition:e,thenBranch:t,elseBranch:[this.parse_stmt()]}):{kind:"IfStmt",condition:e,thenBranch:t,elseBranch:[]}}parse_block(){this.expect(26,"Unexpected token found while parsing block. Expected opening brace.");let e=[];for(;this.at().type!=28&&this.at().type!=27;)e.push(this.parse_stmt());return this.expect(27,"Unexpected token found while parsing block. Expected closing brace."),e}parse_task_declaration(){this.eat();let e=this.expect(1,"Unexpected token found while parsing task declaration. Expected function name.").value,a=this.parse_args().map(i=>(i.kind!="Identifier"&&(console.error("Unexpected token found while parsing function declaration. Expected identifier in parameters."),Deno.exit(1)),i.symbol)),n=this.parse_block();return{kind:"TaskDeclaration",name:e,params:a,body:n}}parse_var_declaration(){this.eat();let e=[];for(t.call(this);this.at().type==20;)this.eat(),t.call(this);return{kind:"VarDeclaration",variables:e};function t(){let a=this.expect(1,"Expected identifier name following 'comma' in variable declaration."),n,i=this.at().type==5;if(i&&this.eat(),this.at().type==4||this.at().type==19)this.eat(),n=this.parse_stmt();else throw new Error("Unexpected token found following identifier name. Expected to or = operator.");i&&!n&&(console.error("Expected expression or value following 'always'."),Deno.exit(1)),e.push({identifier:{kind:"Identifier",symbol:a.value},constant:i,value:n})}}parse_expr(){return this.parse_assignment_expr()}parse_assignment_expr(){this.at().type==6&&this.eat();let e=this.parse_list_call_expr();if(this.at().type==4||this.at().type==19){this.eat();let t=this.parse_stmt();return{kind:"AssignmentExpr",assignee:e,value:t}}return e}parse_list_expr(){if(this.at().type==24){this.eat();let e=this.parse_list_values();return this.expect(25,"Unexpected token found while parsing list. Expected closing bracket."),{kind:"ListExpr",values:e}}return this.parse_logical_expr()}parse_list_values(){let e=[];for(;this.at().type!=25;)e.push(this.parse_stmt()),this.at().type==20&&this.eat();return e}parse_logical_expr(){let e=this.parse_conditional_expr();for(;this.at().value=="and"||this.at().value=="or";){let t=this.eat().value,a=this.parse_logical_expr();e={kind:"LogicalExpr",left:e,right:a,operator:t}}return e}parse_conditional_expr(){let e=this.parse_additive_expr();if(this.at().type==18){let t=this.eat().value,a=this.parse_additive_expr();for(e={kind:"ConditionalExpr",left:e,right:a,operator:t};this.at().type==18;){let n=this.eat().value,i=this.parse_additive_expr(),s=i;i={kind:"ConditionalExpr",left:a,right:i,operator:n},e={kind:"LogicalExpr",left:e,right:i,operator:"and"},a=s}}return e}parse_additive_expr(){let e=this.parse_multiplicitave_expr();for(;this.at().value=="plus"||this.at().value=="minus"||this.at().value=="+"||this.at().value=="-";){let t=this.eat().value,a=this.parse_expr();e={kind:"BinaryExpr",left:e,right:a,operator:t}}return e}parse_multiplicitave_expr(){let e=this.parse_call_member_expr();for(;this.at().value=="divide"||this.at().value=="times"||this.at().value=="modulo"||this.at().value=="/"||this.at().value=="*"||this.at().value=="%";){let t=this.eat().value,a=this.parse_call_member_expr();e={kind:"BinaryExpr",left:e,right:a,operator:t}}return e}parse_call_member_expr(){let e=this.parse_range_expr();return this.at().type==22?this.parse_call_expr(e):e}parse_list_call_expr(){let e=this.parse_list_expr();return this.at().type==24&&(e=this.parse_list_index_expr(e)),e}parse_list_index_expr(e){this.expect(24,"Unexpected token found while parsing list index. Expected opening bracket.");let t=this.parse_expr();return this.expect(25,"Unexpected token found while parsing list index. Expected closing bracket."),{kind:"ListCallExpr",caller:e,index:t}}parse_call_expr(e){let t={kind:"CallExpr",caller:e,args:this.parse_args()};return this.at().type==22&&(t=this.parse_call_expr(t)),t}parse_args(){this.expect(22,"Unexpected token found while parsing arguments. Expected opening parenthesis.");let e=this.at().type==23?[]:this.parse_args_list();return this.expect(23,"Unexpected token found while parsing arguments. Expected closing parenthesis."),e}parse_args_list(){let e=[this.parse_assignment_expr()];for(;this.at().type==20;)this.eat(),e.push(this.parse_assignment_expr());return e}parse_range_expr(){let e=this.parse_unary_expr();if(this.at().type==21){this.eat();let t=this.parse_unary_expr();return{kind:"RangeExpr",from:e,to:t}}return e}parse_unary_expr(){if(this.at().value=="plus"||this.at().value=="minus"||this.at().value=="+"||this.at().value=="-"){let e=this.eat().value;return{kind:"UnaryExpr",value:this.parse_unary_expr(),operator:e}}return this.parse_primary_expr()}parse_primary_expr(){switch(this.at().type){case 1:return{kind:"Identifier",symbol:this.eat().value};case 0:return{kind:"NumericLiteral",value:parseFloat(this.eat().value)};case 2:return{kind:"StringLiteral",value:this.eat().value};case 22:{this.eat();let t=this.parse_expr();return this.expect(23,"Unexpected token found inside parenthesised expression. Expected closing parenthesis."),t}default:console.error("Unexpected token found during parsing!",this.at()),Deno.exit(1)}}};function c(){return{type:"null",value:null}}function v(r){return{type:"number",value:r}}function x(r=!0){return{type:"boolean",value:r}}function f(r){return{type:"string",value:r}}function d(r){return{type:"list",values:r}}function E(r){return{type:"native-task",call:r}}var H=(r,e,t)=>{let a=i=>i.type=="null"?"null":i.type=="boolean"?i.value?"true":"false":i.type=="number"?i.value.toString():i.type=="string"?i.value:i.type=="list"?"["+i.values.map(l=>a(l)).join(", ")+"]":Array.isArray(i)?"["+i.map(l=>a(l)).join(", ")+"]":"unknown argument type",n=r.map(i=>a(i)).join(" ");return console.log(n),f(n)},Q=(r,e,t)=>{let a=r[0];if(a.type!="string")throw new Error("Cannot ask for a non-string prompt.");let n=prompt(a.value);return f(n||"")},X={print:H,ask:Q},y=X;var h=class{parent;variables;constants;constructor(e){this.parent=e,this.variables=new Map,this.constants=new Set}createGlobalEnv(){return this.declareVar("null",c(),!0),this.declareVar("true",x(!0),!0),this.declareVar("false",x(!1),!0),this.declareVar("print",E(y.print),!0),this.declareVar("ask",E(y.ask),!0),this}declareVar(e,t,a){if(this.variables.has(e))throw`Cannot declare variable ${e}. As it already is defined.`;return this.variables.set(e,t),a&&this.constants.add(e),t}assignVar(e,t){let a=this.resolve(e);if(a.constants.has(e))throw`Cannot assign to constant variable ${e}.`;return a.variables.set(e,t),t}lookupVar(e){return this.resolve(e).variables.get(e)}resolve(e){if(this.variables.has(e))return this;if(this.parent==null)throw`Cannot resolve '${e}' as it does not exist.`;return this.parent.resolve(e)}};function Z(r,e,t){let a;if(t=="plus"||t=="+")a=r.value+e.value;else if(t=="minus"||t=="-")a=r.value-e.value;else if(t=="times"||t=="*")a=r.value*e.value;else if(t=="divide"||t=="/"){if(e.value==0)throw new Error("Division by zero!");a=r.value/e.value}else a=r.value%e.value;return{value:a,type:"number"}}function ee(r,e,t){let a;if(t=="plus"||t=="+")a=r.value+e.value;else throw new Error(`Invalid binary operator: ${t}`);return f(a)}function w(r,e,t){let a=p(r.left,e,t),n=p(r.right,e,t);if(a.type=="number"&&n.type=="number")return Z(a,n,r.operator);if(a.type=="string"&&n.type=="string")return ee(a,n,r.operator);if(a.type=="list"&&n.type=="list"){let i=a,s=n;if(r.operator=="plus"||r.operator=="+")return d(i.values.concat(s.values))}else if(a.type=="list"&&n.type=="number"){let i=a,s=n;if(r.operator=="times"||r.operator=="*"){let l=[];for(let o=0;o<s.value;o++)l.push(...i.values);return d(l)}}else if(a.type=="number"&&n.type=="list"){let i=a,s=n;if(r.operator=="times"||r.operator=="*"){let l=[];for(let o=0;o<i.value;o++)l.push(...s.values);return d(l)}}else if(a.type=="string"&&n.type=="number"){let i=a,s=n;if(r.operator=="times"||r.operator=="*"){let l="";for(let o=0;o<s.value;o++)l+=i.value;return f(l)}}else if(a.type=="number"&&n.type=="string"){let i=a,s=n;if(r.operator=="times"||r.operator=="*"){let l="";for(let o=0;o<i.value;o++)l+=s.value;return f(l)}}return c()}function R(r,e,t){return r.operator=="-"||r.operator=="minus"?{value:p(r.value,e,t).value*-1,type:"number"}:r.operator=="+"||r.operator=="plus"?{value:p(r.value,e,t).value,type:"number"}:c()}function L(r,e){return e.lookupVar(r.symbol)}function O(r,e,t){let a=r.values.map(n=>p(n,e,t));return d(a)}function B(r,e,t){let a=p(r.index,e,t);if(a.type=="number"){let n=p(r.caller,e,t),i=c(),s=a;if(n.type=="list"){let l=n;if(s.value<0){if(Math.abs(s.value)>l.values.length)throw new Error("Index out of bounds");i=l.values[l.values.length+s.value]}else{if(s.value>=l.values.length)throw new Error("Index out of bounds");i=l.values[s.value]}}else if(n.type=="string"){let l=n;if(s.value<0){if(Math.abs(s.value)>l.value.length)throw new Error("Index out of bounds");i=f(l.value[l.value.length+s.value])}else{if(s.value>=l.value.length)throw new Error("Index out of bounds");i=f(l.value[s.value])}}else throw new Error(`Invalid caller type: ${n.type}`);return i}else if(a.type=="list"){let n=p(r.caller,e,t),s=a.values.map(o=>{if(o.type!="number")throw new Error("Invalid index expression, expected number");return o.value}),l=[];if(n.type=="string"){let o=n;for(let u of s)if(u<0){if(Math.abs(u)>o.value.length)throw new Error("Index out of bounds");l.push(f(o.value[o.value.length+u]))}else{if(u>=o.value.length)throw new Error("Index out of bounds");l.push(f(o.value[u]))}return f(l.map(u=>u.value).join(""))}else if(n.type=="list"){let o=n;for(let u of s)if(u<0){if(Math.abs(u)>o.values.length)throw new Error("Index out of bounds");l.push(o.values[o.values.length+u])}else{if(u>=o.values.length)throw new Error("Index out of bounds");l.push(o.values[u])}return d(l)}else throw new Error(`Invalid caller type: ${n.type}`)}throw new Error("Invalid index expression, expected number")}function C(r,e,t){if(r.assignee.kind=="Identifier"){let a=r.assignee.symbol;return e.assignVar(a,p(r.value,e,t))}else if(r.assignee.kind=="ListCallExpr"){let a=r.assignee,n=a.caller.symbol,i=p(a.index,e,t),s=p(a.caller,e,t);if(i.type!="number")throw new Error("Invalid index expression, expected number");if(i.value<0){if(Math.abs(i.value)>s.values.length)throw new Error("Index out of bounds");s.values[s.values.length+i.value]=p(r.value,e,t)}else{if(i.value>=s.values.length)throw new Error("Index out of bounds");s.values[i.value]=p(r.value,e,t)}return n?e.assignVar(n,s):s}throw new Error(`Invalid LHS of expr: ${JSON.stringify(r.assignee)}`)}function N(r,e,t){let a=p(r.left,e,t);if(a.type=="boolean"){let n;if(r.operator=="and"){let i=p(r.right,e,t);n=a.value&&i.value}else if(r.operator=="or"){if(a.value)return x(!0);n=p(r.right,e,t).value}else throw new Error(`Invalid logical operator: ${r.operator}`);return x(n)}return c()}function F(r,e,t){let a=p(r.left,e,t),n=p(r.right,e,t);if(a.type=="number"&&n.type=="number"){let i;return r.operator=="=="?i=a.value==n.value:r.operator=="!="?i=a.value!=n.value:r.operator=="<"?i=a.value<n.value:r.operator==">"?i=a.value>n.value:r.operator=="<="?i=a.value<=n.value:i=a.value>=n.value,x(i)}return c()}function D(r,e,t){let a=r.args.map(i=>p(i,e,t)),n=p(r.caller,e,t);if(n.type=="task"){let i=n,s=new h(i.declarationEnv);if(a.length!=i.params.length)throw new Error(`Invalid number of arguments to the task ${i.name}; Expected ${i.params.length}, got ${a.length}`);for(let o=0;o<i.params.length;o++)s.declareVar(i.params[o],a[o],!1);let l=c();for(let o of i.body)l=p(o,s,t);return l}else if(n.type=="native-task")return n.call(a,e,t);throw new Error(`Invalid call expression: ${JSON.stringify(r)}`)}function U(r,e,t){let a=p(r.from,e,t),n=p(r.to,e,t);if(a.type!="number"||n.type!="number")throw new Error("Invalid range expression, expected numbers");let i=[];if(a.value<n.value)for(let s=a.value;s<=n.value;s++)i.push(s);else for(let s=a.value;s>=n.value;s--)i.push(s);return d(i.map(s=>({type:"number",value:s})))}function M(r,e,t){let a=c();for(let n of r.body)a=p(n,e,t);return a}function A(r,e,t){let a=c();for(let n of r.variables)a=e.declareVar(n.identifier.symbol,p(n.value,e,t),n.constant);return a}function T(r,e){let t={type:"task",name:r.name,params:r.params,declarationEnv:e,body:r.body};return e.declareVar(r.name,t,!0)}function K(r,e,t){let a=p(r.condition,e,t);a.type!="boolean"&&(console.error("Invalid condition for if statement"),Deno.exit(1));let n=c(),i=new h(e);if(a.value)for(let s of r.thenBranch)n=p(s,i,t);else for(let s of r.elseBranch)n=p(s,i,t);return n}function P(r,e,t){let a=p(r.from,e,t),n=p(r.to,e,t),i=p(r.by,e,t);(a.type!="number"||n.type!="number")&&(console.error("Invalid from statement, expected numbers"),Deno.exit(1));let s=[],l=new h(e);if(l.declareVar(r.identifier.symbol,c(),!1),a.value<n.value)for(let o=a.value;o<=n.value;o+=i.value){l.assignVar(r.identifier.symbol,v(o));for(let u of r.body)s.push(p(u,l,t))}else for(let o=a.value;o>=n.value;o-=i.value){l.assignVar(r.identifier.symbol,v(o));for(let u of r.body)s.push(p(u,l,t))}return{type:"list",values:s}}function $(r,e,t){let a=p(r.iterable,e,t);a.type!="list"&&(console.error("Invalid for-in statement, expected string"),Deno.exit(1));let n=[],i=new h(e);i.declareVar(r.identifier.symbol,c(),!1);for(let s=0;s<a.values.length;s++){i.assignVar(r.identifier.symbol,a.values[s]);for(let l of r.body)n.push(p(l,i,t))}return{type:"list",values:n}}function G(r,e,t){let a=p(r.from,e,t),n=p(r.to,e,t),i=p(r.by,e,t);(a.type!="number"||n.type!="number"||i.type!="number")&&(console.error("Invalid from statement, expected numbers"),Deno.exit(1));let s=[],l=new h(e);if(a.value<n.value)for(let o=a.value;o<=n.value;o+=i.value)for(let u of r.body)s.push(p(u,l,t));else for(let o=a.value;o>=n.value;o-=i.value)for(let u of r.body)s.push(p(u,l,t));return{type:"list",values:s}}function p(r,e,t){switch(r.kind){case"NumericLiteral":return v(r.value);case"NullLiteral":return c();case"StringLiteral":return f(r.value);case"Identifier":return L(r,e);case"ListExpr":return O(r,e,t);case"CallExpr":return D(r,e,t);case"ListCallExpr":return B(r,e,t);case"AssignmentExpr":return C(r,e,t);case"LogicalExpr":return N(r,e,t);case"ConditionalExpr":return F(r,e,t);case"BinaryExpr":return w(r,e,t);case"RangeExpr":return U(r,e,t);case"UnaryExpr":return R(r,e,t);case"Program":return M(r,e,t);case"VarDeclaration":return A(r,e,t);case"TaskDeclaration":return T(r,e);case"IfStmt":return K(r,e,t);case"ForFromStmt":return P(r,e,t);case"ForInStmt":return $(r,e,t);case"FromStmt":return G(r,e,t);default:console.error("This AST Node has not yet been setup for interpretation.",r),Deno.exit(0)}}var g=class{inputStream=[];outputStream=[];constructor(e){e&&this.feedInput(e)}read(){return this.inputStream.shift()||c()}write(e){this.outputStream.push(JSON.stringify(e))}getOutput(){return this.outputStream.join(" ")}clearOutput(){this.outputStream=[]}clearInput(){this.inputStream=[]}feedInput(e){this.inputStream=e.split(" ").map(t=>{let a=!isNaN(Number(t)),n=t=="true"||t=="false";return a?v(Number(t)):n?x(t=="true"):c()})}};var j=new _,V=new h,q=new g;V.createGlobalEnv();var b=Deno.args[0];b==="--repl"?te():b?re(b):console.log("No file or option specified");function te(){for(console.log(`
Repl v0.1 - Leaf
`);;){let r=prompt("> ");(!r||r.includes("exit"))&&Deno.exit(0);let e=j.produceAST(r),t;try{t=p(e,V,q),console.log(t)}catch(a){console.error(a);continue}}}function re(r){r.endsWith(".leaf")||(console.error("Invalid file type, expected .leaf"),Deno.exit(1));let e=Deno.readTextFileSync(r),t=j.produceAST(e);p(t,V,q)}})();
